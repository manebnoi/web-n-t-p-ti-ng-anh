<!DOCTYPE html>
<html lang="en" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Master - THCS Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0c29;
            --primary: #00d2ff;
            --secondary: #928dab;
            --accent: #3a7bd5;
            --neon-purple: #bc13fe;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            user-select: none; /* NgƒÉn b√¥i ƒëen ƒë·ªÉ copy */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Tech Background Elements */
        .bg-particles {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(68, 11, 168, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 210, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(188, 19, 254, 0.3);
            position: relative;
            text-align: center;
        }

        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--primary);
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(90deg, var(--accent), var(--neon-purple));
            border: none;
            padding: 12px 30px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 50px;
            transition: 0.3s;
            box-shadow: 0 0 15px var(--accent);
            margin: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--neon-purple);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            box-shadow: none;
            border: 1px solid var(--primary);
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Inputs */
        input {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: white;
            padding: 15px;
            border-radius: 10px;
            width: 80%;
            margin: 10px 0;
            font-size: 1.1rem;
            outline: none;
        }
        
        input:focus {
            box-shadow: 0 0 10px var(--primary);
        }

        /* HUD */
        .hud {
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-family: 'Orbitron', sans-serif;
            border-bottom: 2px solid var(--primary);
        }

        .timer { color: #ff4757; }
        .score { color: #2ed573; }
        .gems { color: #ffa502; }

        /* Question Area */
        .question-box {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            line-height: 1.6;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--secondary);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .option-card:hover {
            background: rgba(0, 210, 255, 0.2);
            border-color: var(--primary);
        }

        /* Scramble Words */
        .word-bank, .sentence-drop {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            min-height: 50px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .draggable-word {
            background: var(--accent);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Leaderboard */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { color: var(--primary); }

        /* Controls */
        .music-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: 1px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            z-index: 100;
        }

        /* Feedback */
        .feedback {
            font-size: 1.2rem;
            height: 30px;
            margin-top: 10px;
            font-weight: bold;
        }
        .correct { color: #2ed573; text-shadow: 0 0 10px #2ed573; }
        .wrong { color: #ff4757; text-shadow: 0 0 10px #ff4757; }

    </style>
</head>
<body>

    <div class="bg-particles"></div>
    <button class="music-toggle" onclick="toggleMusic()">üéµ</button>
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3?filename=cyberpunk-2099-10510.mp3" type="audio/mpeg">
    </audio>

    <div class="container">
        
        <div id="login-screen" class="screen active">
            <h1>English Master</h1>
            <p>√în T·∫≠p Ti·∫øng Anh C·∫•p THCS (L·ªõp 6-9)</p>
            <input type="text" id="username" placeholder="Nh·∫≠p H·ªç v√† T√™n" autocomplete="off">
            <input type="text" id="userclass" placeholder="Nh·∫≠p L·ªõp (V√≠ d·ª•: 8A)" autocomplete="off">
            <br>
            <button class="btn" onclick="checkLogin()">START MISSION</button>
            <br>
            <button class="btn btn-secondary" onclick="showLeaderboard()">B·∫£ng X·∫øp H·∫°ng</button>
        </div>

        <div id="game-screen" class="screen">
            <div class="hud">
                <div class="timer">‚è∞ <span id="time-display">25:00</span></div>
                <div>Level: <span id="level-display">1</span> | Q: <span id="q-num">1</span>/20</div>
                <div class="score">‚≠ê <span id="score-display">0</span></div>
                <div class="gems">üíé <span id="gem-display">0</span></div>
            </div>

            <div class="question-container">
                <h3 id="question-type-title" style="color:var(--secondary)">Type</h3>
                <div class="question-box" id="question-text">
                    Loading question...
                </div>

                <div id="interaction-area"></div>
                
                <div class="feedback" id="feedback-msg"></div>
            </div>
        </div>

        <div id="result-screen" class="screen">
            <h2>Mission Complete!</h2>
            <p>ƒêi·ªÉm s·ªë: <span id="final-score">0</span></p>
            <p>ƒê√° qu√Ω nh·∫≠n ƒë∆∞·ª£c: <span id="final-gems">0</span> üíé</p>
            <div id="reward-msg" style="color: var(--primary); margin: 20px 0; font-weight: bold;"></div>
            <button class="btn" onclick="nextLevel()">C·∫•p ƒë·ªô ti·∫øp theo</button>
            <button class="btn btn-secondary" onclick="resetGame()">V·ªÅ trang ch·ªß</button>
        </div>

        <div id="leaderboard-screen" class="screen">
            <h2>Hall of Fame</h2>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button class="btn" onclick="showLogin()">Quay l·∫°i</button>
        </div>

    </div>

    <script>
        // --- DATABASE C√ÇU H·ªéI (M·∫´u kho·∫£ng 30 c√¢u, b·∫°n c√≥ th·ªÉ copy paste th√™m ƒë·ªÉ ƒë·ªß 250 c√¢u) ---
        // Types: 'mcq' (Tr·∫Øc nghi·ªám), 'scramble' (Gh√©p t·ª´), 'error' (T√¨m l·ªói), 'rewrite' (S·ª≠a c√¢u)
        // Level: 1 (D·ªÖ), 2 (Trung b√¨nh), 3 (Kh√≥) - ·ªû ƒë√¢y ta g·ªôp chung pool ƒë·ªÉ random.
        
            const questionBank = [
    // --- PH·∫¶N 1: TH√å (TENSES) - TR·∫ÆC NGHI·ªÜM ---
    { type: 'mcq', q: "She _______ her homework at the moment.", options: ["is doing", "does", "did", "has done"], a: "is doing" },
    { type: 'mcq', q: "We _______ this film three times already.", options: ["saw", "see", "have seen", "are seeing"], a: "have seen" },
    { type: 'mcq', q: "When I arrived, they _______ dinner.", options: ["were having", "have", "had", "are having"], a: "were having" },
    { type: 'mcq', q: "By 2025, she _______ from university.", options: ["will graduate", "graduates", "will have graduated", "is graduating"], a: "will have graduated" },
    { type: 'mcq', q: "He usually _______ to school by bike.", options: ["go", "goes", "went", "is going"], a: "goes" },
    { type: 'mcq', q: "I _______ English for five years.", options: ["learn", "learned", "have learned", "am learning"], a: "have learned" },
    { type: 'mcq', q: "She _______ TV when I called her.", options: ["watched", "was watching", "has watched", "watches"], a: "was watching" },
    { type: 'mcq', q: "They _______ here since 2010.", options: ["live", "lived", "have lived", "are living"], a: "have lived" },
    { type: 'mcq', q: "My father _______ home late last night.", options: ["comes", "came", "has come", "is coming"], a: "came" },
    { type: 'mcq', q: "Look! It _______ heavily.", options: ["rains", "rained", "is raining", "has rained"], a: "is raining" },
    { type: 'mcq', q: "She _______ already _______ dinner.", options: ["has / cooked", "is / cooking", "was / cooking", "will / cook"], a: "has / cooked" },
    { type: 'mcq', q: "We _______ to the beach tomorrow.", options: ["go", "went", "will go", "have gone"], a: "will go" },
    { type: 'mcq', q: "He _______ a book when the phone rang.", options: ["reads", "read", "was reading", "has read"], a: "was reading" },
    { type: 'mcq', q: "She _______ never _______ sushi before.", options: ["has / eaten", "is / eating", "was / eating", "will / eat"], a: "has / eaten" },
    { type: 'mcq', q: "By the time we arrived, the train _______.", options: ["leaves", "left", "had left", "has left"], a: "had left" },
    { type: 'mcq', q: "I _______ him since last year.", options: ["don't see", "didn't see", "haven't seen", "won't see"], a: "haven't seen" },
    { type: 'mcq', q: "She _______ to music every evening.", options: ["listen", "listens", "listened", "is listening"], a: "listens" },
    { type: 'mcq', q: "They _______ football when it started to rain.", options: ["play", "played", "were playing", "have played"], a: "were playing" },
    { type: 'mcq', q: "He _______ his keys, so he can't open the door.", options: ["loses", "lost", "has lost", "is losing"], a: "has lost" },
    { type: 'mcq', q: "She _______ as a teacher for ten years.", options: ["works", "worked", "has worked", "is working"], a: "has worked" },
    { type: 'mcq', q: "I _______ my homework before dinner yesterday.", options: ["finish", "finished", "had finished", "have finished"], a: "had finished" },
    { type: 'mcq', q: "He _______ a car last month.", options: ["buys", "bought", "has bought", "is buying"], a: "bought" },
    { type: 'mcq', q: "She _______ for the bus when I saw her.", options: ["waits", "waited", "was waiting", "has waited"], a: "was waiting" },
    { type: 'mcq', q: "We _______ English every Monday.", options: ["study", "studied", "have studied", "are studying"], a: "study" },
    { type: 'mcq', q: "They _______ in this house since they got married.", options: ["live", "lived", "have lived", "are living"], a: "have lived" },
    { type: 'mcq', q: "She _______ tired because she worked late.", options: ["is", "was", "has been", "will be"], a: "was" },
    { type: 'mcq', q: "He _______ his homework yet.", options: ["doesn't finish", "didn't finish", "hasn't finished", "won't finish"], a: "hasn't finished" },
    { type: 'mcq', q: "When we got there, the movie _______.", options: ["starts", "started", "had started", "has started"], a: "had started" },
    { type: 'mcq', q: "She _______ to Paris twice.", options: ["goes", "went", "has gone", "is going"], a: "has gone" },
    { type: 'mcq', q: "I _______ him tomorrow.", options: ["meet", "met", "will meet", "have met"], a: "will meet" },
    { type: 'mcq', q: "He _______ breakfast when I arrived.", options: ["has", "had", "was having", "is having"], a: "was having" },
    { type: 'mcq', q: "She _______ a letter at the moment.", options: ["writes", "wrote", "is writing", "has written"], a: "is writing" },
    { type: 'mcq', q: "They _______ the house before 2010.", options: ["build", "built", "had built", "have built"], a: "had built" },
    { type: 'mcq', q: "I _______ my friend every weekend.", options: ["visit", "visited", "have visited", "am visiting"], a: "visit" },
    { type: 'mcq', q: "She _______ asleep when the phone rang.", options: ["falls", "fell", "was falling", "has fallen"], a: "was falling" },
    { type: 'mcq', q: "He _______ English very well.", options: ["speak", "speaks", "spoke", "has spoken"], a: "speaks" },
    { type: 'mcq', q: "We _______ lunch when she came.", options: ["have", "had", "were having", "are having"], a: "were having" },
    { type: 'mcq', q: "She _______ her keys an hour ago.", options: ["loses", "lost", "has lost", "is losing"], a: "lost" },
    { type: 'mcq', q: "I _______ never _______ such a beautiful place.", options: ["have / seen", "am / seeing", "was / seeing", "will / see"], a: "have / seen" },
    { type: 'mcq', q: "They _______ dinner before we arrived.", options: ["finish", "finished", "had finished", "have finished"], a: "had finished" },
    { type: 'mcq', q: "She usually _______ up at 6 a.m.", options: ["get", "gets", "got", "is getting"], a: "gets" },
    { type: 'mcq', q: "He _______ TV right now.", options: ["watches", "watched", "is watching", "has watched"], a: "is watching" },
    { type: 'mcq', q: "They _______ to Hanoi last summer.", options: ["go", "went", "have gone", "are going"], a: "went" },
    { type: 'mcq', q: "I _______ my homework already.", options: ["do", "did", "have done", "am doing"], a: "have done" },
    { type: 'mcq', q: "She _______ when the teacher entered the room.", options: ["talks", "talked", "was talking", "has talked"], a: "was talking" },
    { type: 'mcq', q: "We _______ English since primary school.", options: ["learn", "learned", "have learned", "are learning"], a: "have learned" },
    { type: 'mcq', q: "He _______ the door before he left.", options: ["locks", "locked", "had locked", "has locked"], a: "had locked" },
    { type: 'mcq', q: "She _______ very happy yesterday.", options: ["is", "was", "has been", "will be"], a: "was" },
    { type: 'mcq', q: "I _______ to music while doing homework.", options: ["listen", "listened", "am listening", "have listened"], a: "am listening" },
    { type: 'mcq', q: "They _______ in this city for a long time.", options: ["live", "lived", "have lived", "are living"], a: "have lived" },

    // --- PH·∫¶N 2: C√ÇU B·ªä ƒê·ªòNG (PASSIVE VOICE) - GH√âP T·ª™ ---
    // (ƒê√£ chuy·ªÉn t·ª´ Rewrite sang Scramble ƒë·ªÉ ph√π h·ª£p v·ªõi game)
    { type: 'scramble', q: "Rewrite: They clean the classroom every day.", a: "The classroom is cleaned every day" },
    { type: 'scramble', q: "Rewrite: She wrote this letter yesterday.", a: "This letter was written yesterday" },
    { type: 'scramble', q: "Rewrite: They will build a new hospital.", a: "A new hospital will be built" },
    { type: 'scramble', q: "Rewrite: People speak English all over the world.", a: "English is spoken all over the world" },
    { type: 'scramble', q: "Rewrite: Someone has stolen my phone.", a: "My phone has been stolen" },
    { type: 'scramble', q: "Rewrite: They are repairing the road now.", a: "The road is being repaired now" },
    { type: 'scramble', q: "Rewrite: He finished his homework last night.", a: "His homework was finished last night" },
    { type: 'scramble', q: "Rewrite: They have built this bridge recently.", a: "This bridge has been built recently" },
    { type: 'scramble', q: "Rewrite: She will invite him to the party.", a: "He will be invited to the party" },
    { type: 'scramble', q: "Rewrite: They don't allow students to use phones.", a: "Students are not allowed to use phones" },

    // --- PH·∫¶N 3: C√ÇU B·ªä ƒê·ªòNG - TR·∫ÆC NGHI·ªÜM ---
    { type: 'mcq', q: "The house _______ last year.", options: ["build", "built", "was built", "is built"], a: "was built" },
    { type: 'mcq', q: "English _______ in many countries.", options: ["speaks", "is spoken", "spoke", "has spoken"], a: "is spoken" },
    { type: 'mcq', q: "The homework _______ by the students.", options: ["do", "did", "is done", "has done"], a: "is done" },
    { type: 'mcq', q: "The letter _______ tomorrow.", options: ["will send", "will be sent", "is sent", "has sent"], a: "will be sent" },
    { type: 'mcq', q: "The room _______ every day.", options: ["cleans", "is cleaned", "cleaned", "has cleaned"], a: "is cleaned" },
    { type: 'mcq', q: "The car _______ repaired at the moment.", options: ["is", "is being", "has been", "was"], a: "is being" },
    { type: 'mcq', q: "My bike _______ stolen last night.", options: ["is", "was", "has", "has been"], a: "was" },
    { type: 'mcq', q: "This book _______ written by a famous author.", options: ["is", "was", "has", "is being"], a: "was" },
    { type: 'mcq', q: "The test _______ next Monday.", options: ["will hold", "will be held", "is held", "has held"], a: "will be held" },
    { type: 'mcq', q: "The cake _______ by my mother.", options: ["makes", "made", "is made", "has made"], a: "is made" },

    // --- PH·∫¶N 4: T√åM L·ªñI SAI (ERROR IDENTIFICATION) ---
    // (ƒê√£ format l·∫°i ƒë·ªÉ hi·ªán A, B, C, D r√µ r√†ng)
    { type: 'error', q: "The homework (A)are (B)done (C)by (D)students.", parts: ["are", "done", "by", "students"], a: "are", full: "The homework <u>are</u> done by students." },
    { type: 'error', q: "The letter (A)was (B)send (C)yesterday.", parts: ["was", "send", "yesterday"], a: "send", full: "The letter was <u>send</u> yesterday." },
    { type: 'error', q: "English (A)is (B)speak (C)here.", parts: ["is", "speak", "here"], a: "speak", full: "English is <u>speak</u> here." },
    { type: 'error', q: "The house (A)is (B)build (C)last year.", parts: ["is", "build", "last year"], a: "build", full: "The house is <u>build</u> last year." },
    { type: 'error', q: "The book (A)were (B)written (C)by (D)him.", parts: ["were", "written", "by", "him"], a: "were", full: "The book <u>were</u> written by him." },
    { type: 'error', q: "The room (A)is (B)clean (C)every day.", parts: ["is", "clean", "every day"], a: "clean", full: "The room is <u>clean</u> every day." },
    { type: 'error', q: "The car (A)has (B)repair (C)recently.", parts: ["has", "repair", "recently"], a: "repair", full: "The car has <u>repair</u> recently." },
    { type: 'error', q: "This song (A)is (B)sing (C)by (D)her.", parts: ["is", "sing", "by", "her"], a: "sing", full: "This song is <u>sing</u> by her." },
    { type: 'error', q: "The windows (A)are (B)break (C)by (D)the wind.", parts: ["are", "break", "by", "the wind"], a: "break", full: "The windows are <u>break</u> by the wind." },
    { type: 'error', q: "The problem (A)was (B)solve (C)quickly.", parts: ["was", "solve", "quickly"], a: "solve", full: "The problem was <u>solve</u> quickly." },

    // --- PH·∫¶N 5: B·ªä ƒê·ªòNG - GH√âP T·ª™ (Ti·∫øp) ---
    { type: 'scramble', q: "Rewrite: Someone is painting the house.", a: "The house is being painted" },
    { type: 'scramble', q: "Rewrite: They had finished the work before noon.", a: "The work had been finished before noon" },
    { type: 'scramble', q: "Rewrite: She can solve this problem.", a: "This problem can be solved" },
    { type: 'scramble', q: "Rewrite: They must obey the rules.", a: "The rules must be obeyed" },
    { type: 'scramble', q: "Rewrite: Nobody has cleaned the room yet.", a: "The room hasn't been cleaned yet" },
    { type: 'scramble', q: "Rewrite: They are going to open a new shop.", a: "A new shop is going to be opened" },
    { type: 'scramble', q: "Rewrite: People believe that he is honest.", a: "It is believed that he is honest" },
    { type: 'scramble', q: "Rewrite: They didn't invite her to the meeting.", a: "She wasn't invited to the meeting" },
    { type: 'scramble', q: "Rewrite: Someone will announce the results tomorrow.", a: "The results will be announced tomorrow" },
    { type: 'scramble', q: "Rewrite: They have just repaired the computer.", a: "The computer has just been repaired" },

    // --- PH·∫¶N 6: B·ªä ƒê·ªòNG - TR·∫ÆC NGHI·ªÜM (Ti·∫øp) ---
    { type: 'mcq', q: "The classroom _______ cleaned after school.", options: ["is", "is being", "was", "has"], a: "is" },
    { type: 'mcq', q: "The dishes _______ washed by my sister.", options: ["are", "is", "were", "be"], a: "are" },
    { type: 'mcq', q: "This song _______ often played on the radio.", options: ["is", "was", "has", "will"], a: "is" },
    { type: 'mcq', q: "The report _______ finished tomorrow.", options: ["is", "will be", "was", "has been"], a: "will be" },
    { type: 'mcq', q: "The match _______ postponed because of rain.", options: ["is", "was", "has", "will"], a: "was" },
    { type: 'mcq', q: "My homework _______ checked by the teacher.", options: ["is", "are", "was", "be"], a: "is" },
    { type: 'mcq', q: "The rules _______ explained clearly.", options: ["is", "are", "was", "be"], a: "are" },
    { type: 'mcq', q: "The window _______ broken last night.", options: ["is", "was", "has", "is being"], a: "was" },
    { type: 'mcq', q: "The project _______ completed on time.", options: ["is", "was", "has been", "will"], a: "has been" },
    { type: 'mcq', q: "The cake _______ eaten already.", options: ["is", "was", "has been", "will be"], a: "has been" },

    // --- PH·∫¶N 7: C√ÇU ƒêI·ªÄU KI·ªÜN & C√ÇU ∆Ø·ªöC - TR·∫ÆC NGHI·ªÜM ---
    { type: 'mcq', q: "If I _______ you, I wouldn't do that.", options: ["am", "was", "were", "be"], a: "were" },
    { type: 'mcq', q: "If it rains, we _______ at home.", options: ["stay", "will stay", "stayed", "would stay"], a: "will stay" },
    { type: 'mcq', q: "If she _______ harder, she would pass the exam.", options: ["studies", "studied", "study", "will study"], a: "studied" },
    { type: 'mcq', q: "If we had more time, we _______ the museum.", options: ["visit", "will visit", "would visit", "visited"], a: "would visit" },
    { type: 'mcq', q: "If he _______ early, he won't miss the bus.", options: ["leave", "leaves", "left", "would leave"], a: "leaves" },
    { type: 'mcq', q: "If I had known about the test, I _______ harder.", options: ["study", "will study", "would study", "would have studied"], a: "would have studied" },
    { type: 'mcq', q: "You will succeed if you _______ your best.", options: ["try", "tried", "will try", "would try"], a: "try" },
    { type: 'mcq', q: "If she were taller, she _______ a model.", options: ["becomes", "will become", "would become", "became"], a: "would become" },
    { type: 'mcq', q: "If they had left earlier, they _______ late.", options: ["won't be", "wouldn't be", "aren't", "weren't"], a: "wouldn't be" },
    { type: 'mcq', q: "If it _______ tomorrow, we will cancel the trip.", options: ["rain", "rains", "rained", "will rain"], a: "rains" },

    // --- PH·∫¶N 8: C√ÇU ∆Ø·ªöC (WISH) - GH√âP T·ª™ ---
    { type: 'scramble', q: "Rewrite: I don't have a bike. (I wish...)", a: "I wish I had a bike" },
    { type: 'scramble', q: "Rewrite: She can't swim. (She wishes...)", a: "She wishes she could swim" },
    { type: 'scramble', q: "Rewrite: I am not rich. (I wish...)", a: "I wish I were rich" },
    { type: 'scramble', q: "Rewrite: He didn't study hard. (He wishes...)", a: "He wishes he had studied hard" },
    { type: 'scramble', q: "Rewrite: It is raining now. (I wish...)", a: "I wish it were not raining" },
    { type: 'scramble', q: "Rewrite: I can't speak English well. (I wish...)", a: "I wish I could speak English well" },
    { type: 'scramble', q: "Rewrite: She was late for school. (She wishes...)", a: "She wishes she hadn't been late for school" },
    { type: 'scramble', q: "Rewrite: We don't live near the school. (We wish...)", a: "We wish we lived near the school" },
    { type: 'scramble', q: "Rewrite: He didn't listen to my advice. (He wishes...)", a: "He wishes he had listened to my advice" },
    { type: 'scramble', q: "Rewrite: I have too much homework. (I wish...)", a: "I wish I didn't have so much homework" },

    // --- PH·∫¶N 9: C√ÇU ƒêI·ªÄU KI·ªÜN (Ti·∫øp) ---
    { type: 'mcq', q: "If she _______ more careful, she wouldn't make mistakes.", options: ["is", "was", "were", "had been"], a: "were" },
    { type: 'mcq', q: "If you heat ice, it _______.", options: ["melts", "melted", "will melt", "would melt"], a: "melts" },
    { type: 'mcq', q: "If I see him, I _______ him the news.", options: ["tell", "told", "will tell", "would tell"], a: "will tell" },
    { type: 'mcq', q: "If we had known the way, we _______ lost.", options: ["won't get", "wouldn't get", "wouldn't have got", "did get"], a: "wouldn't have got" },
    { type: 'mcq', q: "If he weren't busy, he _______ us.", options: ["help", "helps", "would help", "will help"], a: "would help" },

    // --- PH·∫¶N 10: S·∫ÆP X·∫æP C√ÇU ƒêI·ªÄU KI·ªÜN ---
    { type: 'scramble', q: "Arrange: If / rain / it / will / stay / we / home", a: "If it rains we will stay home" },
    { type: 'scramble', q: "Arrange: had / If / I / time / enough / I / would / travel", a: "If I had enough time I would travel" },
    { type: 'scramble', q: "Arrange: would / you / what / do / were / rich / if / you", a: "What would you do if you were rich" },
    { type: 'scramble', q: "Arrange: wish / I / speak / could / English / well", a: "I wish I could speak English well" },
    { type: 'scramble', q: "Arrange: had / studied / he / passed / if / would / he", a: "If he had studied he would have passed" },

    // --- PH·∫¶N 11: M·ªÜNH ƒê·ªÄ QUAN H·ªÜ (RELATIVE CLAUSES) ---
    { type: 'mcq', q: "If she _______ earlier, she wouldn't be late now.", options: ["left", "had left", "leaves", "would leave"], a: "had left" },
    { type: 'mcq', q: "I wish I _______ taller.", options: ["am", "was", "were", "be"], a: "were" },
    { type: 'mcq', q: "If we save enough money, we _______ a new house.", options: ["buy", "will buy", "bought", "would buy"], a: "will buy" },
    { type: 'mcq', q: "He wishes he _______ so much time playing games.", options: ["doesn't waste", "didn't waste", "hasn't wasted", "won't waste"], a: "didn't waste" },
    { type: 'mcq', q: "If I were you, I _______ that job.", options: ["accept", "will accept", "would accept", "accepted"], a: "would accept" },

    // --- PH·∫¶N 12: C√ÇU ∆Ø·ªöC - GH√âP T·ª™ (Ti·∫øp) ---
    { type: 'scramble', q: "Rewrite: I didn't know her phone number. (I wish...)", a: "I wish I had known her phone number" },
    { type: 'scramble', q: "Rewrite: He can't come today. (He wishes...)", a: "He wishes he could come today" },
    { type: 'scramble', q: "Rewrite: They live far from school. (They wish...)", a: "They wish they lived near school" },
    { type: 'scramble', q: "Rewrite: She failed the exam. (She wishes...)", a: "She wishes she had passed the exam" },
    { type: 'scramble', q: "Rewrite: I am busy now. (I wish...)", a: "I wish I weren't busy now" },

    // --- PH·∫¶N 13: M·ªÜNH ƒê·ªÄ QUAN H·ªÜ - TR·∫ÆC NGHI·ªÜM ---
    { type: 'mcq', q: "If it stops raining, we _______ out.", options: ["go", "will go", "went", "would go"], a: "will go" },
    { type: 'mcq', q: "If I had a map, I _______ lost.", options: ["won't get", "wouldn't get", "didn't get", "haven't got"], a: "wouldn't get" },
    { type: 'mcq', q: "She wishes she _______ more friends.", options: ["has", "had", "will have", "would have"], a: "had" },
    { type: 'mcq', q: "If he had listened to the teacher, he _______ better.", options: ["does", "did", "would do", "would have done"], a: "would have done" },
    { type: 'mcq', q: "If you study hard, you _______ the exam.", options: ["pass", "passed", "will pass", "would pass"], a: "will pass" },

    // --- PH·∫¶N 14: S·∫ÆP X·∫æP T·ª™ ---
    { type: 'scramble', q: "Arrange: wish / I / not / be / late / today", a: "I wish I were not late today" },
    { type: 'scramble', q: "Arrange: would / have / we / gone / if / known / had / we", a: "If we had known we would have gone" },
    { type: 'scramble', q: "Arrange: if / were / what / you / do / free / you", a: "What would you do if you were free" },
    { type: 'scramble', q: "Arrange: wish / she / not / forget / my / birthday", a: "She wishes she didn't forget my birthday" },
    { type: 'scramble', q: "Arrange: had / saved / if / money / I / bought / would / I / it", a: "If I had saved money I would have bought it" },

    // --- PH·∫¶N 15: M·ªÜNH ƒê·ªÄ QUAN H·ªÜ - TR·∫ÆC NGHI·ªÜM (Ti·∫øp) ---
    { type: 'mcq', q: "The boy _______ is standing over there is my brother.", options: ["who", "which", "whom", "whose"], a: "who" },
    { type: 'mcq', q: "The book _______ I bought yesterday is very interesting.", options: ["who", "which", "whose", "where"], a: "which" },
    { type: 'mcq', q: "The girl _______ mother is a teacher lives next door.", options: ["who", "which", "whose", "whom"], a: "whose" },
    { type: 'mcq', q: "This is the place _______ we first met.", options: ["which", "that", "where", "who"], a: "where" },
    { type: 'mcq', q: "The man _______ you met yesterday is my uncle.", options: ["who", "which", "whose", "where"], a: "who" },
    { type: 'mcq', q: "The students _______ study hard will pass the exam.", options: ["which", "who", "whose", "where"], a: "who" },
    { type: 'mcq', q: "The house _______ was built last year is very large.", options: ["who", "which", "whose", "where"], a: "which" },
    { type: 'mcq', q: "That is the girl _______ brother won the prize.", options: ["who", "which", "whose", "whom"], a: "whose" },
    { type: 'mcq', q: "The movie _______ we watched last night was boring.", options: ["who", "which", "where", "whose"], a: "which" },
    { type: 'mcq', q: "The teacher _______ teaches us English is very kind.", options: ["who", "which", "where", "whose"], a: "who" },

    // --- PH·∫¶N 16: T√åM L·ªñI SAI (Ti·∫øp) ---
    { type: 'error', q: "The man (A)which (B)lives (C)next door (D)is friendly.", parts: ["which", "lives", "next door", "is"], a: "which", full: "The man <u>which</u> lives next door is friendly." },
    { type: 'error', q: "The book (A)who (B)I (C)borrowed (D)is interesting.", parts: ["who", "I", "borrowed", "is"], a: "who", full: "The book <u>who</u> I borrowed is interesting." },
    { type: 'error', q: "The girl (A)whose (B)she (C)is (D)singing is my friend.", parts: ["whose", "she", "is", "singing"], a: "she", full: "The girl whose <u>she</u> is singing is my friend." },
    { type: 'error', q: "The place (A)which (B)we (C)met (D)there is beautiful.", parts: ["which", "we", "met", "there"], a: "there", full: "The place which we met <u>there</u> is beautiful." },
    { type: 'error', q: "The student (A)who (B)study (C)hard (D)will succeed.", parts: ["who", "study", "hard", "will"], a: "study", full: "The student who <u>study</u> hard will succeed." },

    // --- PH·∫¶N 17: C√ÇU T∆Ø·ªúNG THU·∫¨T (REPORTED SPEECH) - GH√âP T·ª™ ---
    { type: 'scramble', q: "Rewrite: 'I am a student,' said Nam.", a: "Nam said he was a student" },
    { type: 'scramble', q: "Rewrite: 'I will help you,' she said.", a: "She said she would help me" },
    { type: 'scramble', q: "Rewrite: 'I am doing my homework,' he said.", a: "He said he was doing his homework" },
    { type: 'scramble', q: "Rewrite: 'We have finished the work,' they said.", a: "They said they had finished the work" },
    { type: 'scramble', q: "Rewrite: 'I can't swim,' she said.", a: "She said she couldn't swim" },
    { type: 'scramble', q: "Rewrite: 'I went to Hanoi last year,' he said.", a: "He said he had gone to Hanoi the year before" },
    { type: 'scramble', q: "Rewrite: 'I am tired now,' she said.", a: "She said she was tired then" },
    { type: 'scramble', q: "Rewrite: 'We are studying English,' they said.", a: "They said they were studying English" },
    { type: 'scramble', q: "Rewrite: 'I will call you tomorrow,' he said.", a: "He said he would call me the next day" },
    { type: 'scramble', q: "Rewrite: 'I have lost my keys,' she said.", a: "She said she had lost her keys" },

    // --- PH·∫¶N 18: T∆Ø·ªúNG THU·∫¨T - TR·∫ÆC NGHI·ªÜM ---
    { type: 'mcq', q: "He said that he _______ busy then.", options: ["is", "was", "will be", "has been"], a: "was" },
    { type: 'mcq', q: "She told me that she _______ the test already.", options: ["finishes", "finished", "has finished", "had finished"], a: "had finished" },
    { type: 'mcq', q: "They said they _______ to the party the next day.", options: ["go", "went", "will go", "would go"], a: "would go" },
    { type: 'mcq', q: "He told me that he _______ English very well.", options: ["speaks", "spoke", "spoken", "speaking"], a: "spoke" },
    { type: 'mcq', q: "She said that she _______ busy at that time.", options: ["is", "was", "has been", "will be"], a: "was" },

    // --- PH·∫¶N 19: S·∫ÆP X·∫æP C√ÇU (REPORTED/RELATIVE) ---
    { type: 'scramble', q: "Arrange: boy / who / the / is / playing / my / brother / football", a: "The boy who is playing football is my brother" },
    { type: 'scramble', q: "Arrange: said / he / tired / was / that / he", a: "He said that he was tired" },
    { type: 'scramble', q: "Arrange: girl / whose / doctor / is / mother / the / my / friend / is", a: "The girl whose mother is a doctor is my friend" },
    { type: 'scramble', q: "Arrange: she / said / would / she / come / later / that", a: "She said that she would come later" },
    { type: 'scramble', q: "Arrange: the / which / book / reading / am / I / interesting / is", a: "The book which I am reading is interesting" },

    // --- PH·∫¶N 20: TR·∫ÆC NGHI·ªÜM H·ªñN H·ª¢P ---
    { type: 'mcq', q: "The man _______ car was stolen called the police.", options: ["who", "which", "whose", "where"], a: "whose" },
    { type: 'mcq', q: "This is the school _______ I studied last year.", options: ["who", "which", "where", "whose"], a: "where" },
    { type: 'mcq', q: "She said that she _______ her homework.", options: ["does", "did", "has done", "had done"], a: "had done" },
    { type: 'mcq', q: "The people _______ live here are very friendly.", options: ["who", "which", "whose", "where"], a: "who" },
    { type: 'mcq', q: "He told me that he _______ me the day before.", options: ["meets", "met", "has met", "had met"], a: "had met" },

    // --- PH·∫¶N 21: T∆Ø·ªúNG THU·∫¨T - GH√âP T·ª™ ---
    { type: 'scramble', q: "Rewrite: 'I am going to the library,' she said.", a: "She said she was going to the library" },
    { type: 'scramble', q: "Rewrite: 'We will finish it soon,' they said.", a: "They said they would finish it soon" },
    { type: 'scramble', q: "Rewrite: 'I don't like math,' he said.", a: "He said he didn't like math" },
    { type: 'scramble', q: "Rewrite: 'I am watching TV now,' Nam said.", a: "Nam said he was watching TV then" },
    { type: 'scramble', q: "Rewrite: 'I have lived here for years,' she said.", a: "She said she had lived there for years" },

    // --- PH·∫¶N 22: T√åM L·ªñI SAI (Cu·ªëi) ---
    { type: 'error', q: "The boy (A)who (B)she (C)likes (D)is very kind.", parts: ["who", "she", "likes", "is"], a: "she", full: "The boy who <u>she</u> likes is very kind." },
    { type: 'error', q: "He said (A)that (B)he (C)will (D)come later.", parts: ["that", "he", "will", "come"], a: "will", full: "He said that he <u>will</u> come later." },
    { type: 'error', q: "The place (A)where (B)we (C)met (D)there was crowded.", parts: ["where", "we", "met", "there"], a: "there", full: "The place where we met <u>there</u> was crowded." },
    { type: 'error', q: "She said she (A)is (B)happy (C)then.", parts: ["she", "is", "happy", "then"], a: "is", full: "She said she <u>is</u> happy then." },
    { type: 'error', q: "The student (A)which (B)won (C)the prize (D)is my friend.", parts: ["which", "won", "the prize", "is"], a: "which", full: "The student <u>which</u> won the prize is my friend." }
];

        // --- GAME VARIABLES ---
        let currentUser = { name: "", class: "" };
        let currentLevel = 1;
        let score = 0;
        let gems = 0;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let timerInterval;
        let timeLeft = 1500; // 25 ph√∫t = 1500 gi√¢y
        let isMusicPlaying = false;
        let audio = document.getElementById("bgMusic");

        // --- SYSTEM FUNCTIONS ---

        function toggleMusic() {
            if (isMusicPlaying) {
                audio.pause();
                document.querySelector('.music-toggle').innerHTML = 'üîá';
                document.querySelector('.music-toggle').style.borderColor = '#ff4757';
            } else {
                audio.play().catch(e => console.log("Audio play failed interaction needed"));
                document.querySelector('.music-toggle').innerHTML = 'üéµ';
                document.querySelector('.music-toggle').style.borderColor = '#2ed573';
            }
            isMusicPlaying = !isMusicPlaying;
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function checkLogin() {
            const name = document.getElementById('username').value.trim();
            const cls = document.getElementById('userclass').value.trim();
            if (name && cls) {
                currentUser.name = name;
                currentUser.class = cls;
                startGame();
            } else {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† L·ªõp!");
            }
        }

        function showLogin() { switchScreen('login-screen'); }

        function showLeaderboard() {
            switchScreen('leaderboard-screen');
            updateLeaderboardTable();
        }

        function updateLeaderboardTable() {
            const tbody = document.querySelector('#leaderboard-table tbody');
            tbody.innerHTML = '';
            let data = JSON.parse(localStorage.getItem('cyberEnglish_leaderboard')) || [];
            data.sort((a, b) => b.score - a.score);
            
            data.slice(0, 10).forEach((p, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${p.name}</td>
                    <td>${p.class}</td>
                    <td>${p.score}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveScore() {
            let data = JSON.parse(localStorage.getItem('cyberEnglish_leaderboard')) || [];
            data.push({
                name: currentUser.name,
                class: currentUser.class,
                score: score,
                timestamp: new Date().getTime()
            });
            localStorage.setItem('cyberEnglish_leaderboard', JSON.stringify(data));
        }

        // --- GAMEPLAY LOGIC ---

        function startGame() {
            score = 0;
            currentLevel = 1;
            gems = 0;
            document.getElementById('score-display').innerText = score;
            document.getElementById('gem-display').innerText = gems;
            startLevel();
        }

        function startLevel() {
            switchScreen('game-screen');
            document.getElementById('level-display').innerText = currentLevel;
            timeLeft = 1500; // Reset 25 ph√∫t
            updateTimerDisplay();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("H·∫øt gi·ªù! B·∫°n ph·∫£i l√†m l·∫°i b·ªô c√¢u h·ªèi m·ªõi.");
                    startLevel(); // Restart level
                }
            }, 1000);

            // Ch·ªçn 20 c√¢u h·ªèi ng·∫´u nhi√™n chia ƒë·ªÅu 4 ph·∫ßn (5 c√¢u m·ªói lo·∫°i)
            generateLevelQuestions();
            currentQuestionIndex = 0;
            loadQuestion();
        }

        function generateLevelQuestions() {
            // L·ªçc c√¢u h·ªèi theo lo·∫°i
            const mcqs = questionBank.filter(q => q.type === 'mcq');
            const scrambles = questionBank.filter(q => q.type === 'scramble');
            const errors = questionBank.filter(q => q.type === 'error');
            const rewrites = questionBank.filter(q => q.type === 'rewrite');

            // H√†m shuffle v√† l·∫•y 5 c√¢u
            const getRandom = (arr, num) => {
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, num);
            };

            // ƒê·∫£m b·∫£o ƒë·ªß c√¢u h·ªèi (n·∫øu kh√¥ng ƒë·ªß th√¨ l·∫•y h·∫øt nh·ªØng g√¨ c√≥)
            let selected = [
                ...getRandom(mcqs, 5),
                ...getRandom(scrambles, 5),
                ...getRandom(errors, 5),
                ...getRandom(rewrites, 5)
            ];

            // Tr·ªôn l·∫°i th·ª© t·ª± c√¢u h·ªèi trong m√†n ch∆°i
            currentQuestions = selected.sort(() => 0.5 - Math.random());
        }

        function updateTimerDisplay() {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('time-display').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }

        function loadQuestion() {
            document.getElementById('q-num').innerText = currentQuestionIndex + 1;
            const q = currentQuestions[currentQuestionIndex];
            const typeTitle = document.getElementById('question-type-title');
            const qText = document.getElementById('question-text');
            const area = document.getElementById('interaction-area');
            const feedback = document.getElementById('feedback-msg');
            
            feedback.innerText = "";
            feedback.className = "feedback";
            area.innerHTML = "";

            // Render d·ª±a tr√™n lo·∫°i c√¢u h·ªèi
            if (q.type === 'mcq') {
                typeTitle.innerText = "MULTIPLE CHOICE (Ch·ªçn ƒë√°p √°n ƒë√∫ng)";
                qText.innerText = q.q;
                let grid = document.createElement('div');
                grid.className = 'options-grid';
                // Shuffle options
                let opts = [...q.options].sort(() => 0.5 - Math.random());
                opts.forEach(opt => {
                    let btn = document.createElement('div');
                    btn.className = 'option-card';
                    btn.innerText = opt;
                    btn.onclick = () => handleAnswer(opt, q.a);
                    grid.appendChild(btn);
                });
                area.appendChild(grid);

            } else if (q.type === 'rewrite') {
                typeTitle.innerText = "SENTENCE CORRECTION (Ch·ªçn c√¢u ƒë√∫ng)";
                qText.innerText = q.q;
                let grid = document.createElement('div');
                grid.className = 'options-grid';
                let opts = [...q.options].sort(() => 0.5 - Math.random());
                opts.forEach(opt => {
                    let btn = document.createElement('div');
                    btn.className = 'option-card';
                    btn.innerText = opt;
                    btn.onclick = () => handleAnswer(opt, q.a);
                    grid.appendChild(btn);
                });
                area.appendChild(grid);

            } else if (q.type === 'scramble') {
                typeTitle.innerText = "WORD SCRAMBLE (Gh√©p t·ª´ th√†nh c√¢u)";
                qText.innerText = "S·∫Øp x·∫øp c√°c t·ª´ sau:";
                
                // Logic gh√©p t·ª´
                let words = q.q.replace("Arrange: ", "").split(" / ");
                // Shuffle words
                words.sort(() => 0.5 - Math.random());

                let bank = document.createElement('div');
                bank.className = 'word-bank';
                let dropZone = document.createElement('div');
                dropZone.className = 'sentence-drop';
                dropZone.style.border = "2px dashed var(--secondary)";
                dropZone.style.minHeight = "60px";

                let currentSentence = [];

                words.forEach(w => {
                    let sp = document.createElement('span');
                    sp.className = 'draggable-word';
                    sp.innerText = w;
                    sp.onclick = function() {
                        // Move to drop zone
                        dropZone.appendChild(this);
                        currentSentence.push(w);
                        checkScramble();
                    };
                    bank.appendChild(sp);
                });

                // Reset button for scramble
                let resetBtn = document.createElement('button');
                resetBtn.className = 'btn btn-secondary';
                resetBtn.innerText = "Reset";
                resetBtn.style.fontSize = "0.8rem";
                resetBtn.onclick = () => loadQuestion(); // Reload l·∫°i c√¢u n√†y

                area.appendChild(dropZone);
                area.appendChild(bank);
                area.appendChild(resetBtn);

                function checkScramble() {
                    let constructed = Array.from(dropZone.children).map(c => c.innerText).join(" ");
                    if (dropZone.children.length === words.length) {
                        handleAnswer(constructed, q.a);
                    }
                }

            } else if (q.type === 'error') {
                typeTitle.innerText = "FIND ERROR (T√¨m l·ªói sai)";
                qText.innerHTML = q.full; // Hi·ªÉn th·ªã c√¢u ƒë·∫ßy ƒë·ªß nh∆∞ng user ph·∫£i ch·ªçn ph·∫ßn sai
                qText.style.fontStyle = "italic";
                
                let instruction = document.createElement('p');
                instruction.innerText = "Ch·ªçn ph·∫ßn b·ªã sai:";
                area.appendChild(instruction);

                let grid = document.createElement('div');
                grid.className = 'options-grid';
                q.parts.forEach(part => {
                    let btn = document.createElement('div');
                    btn.className = 'option-card';
                    btn.innerText = part;
                    btn.onclick = () => handleAnswer(part, q.a);
                    grid.appendChild(btn);
                });
                area.appendChild(grid);
            }
        }

        function handleAnswer(userAns, correctAns) {
            const feedback = document.getElementById('feedback-msg');
            
            // Normalize strings for comparison
            if (userAns.trim() === correctAns.trim()) {
                // ƒê√öNG
                feedback.innerText = "CH√çNH X√ÅC! +10 Points";
                feedback.classList.add("correct");
                score += 10;
                document.getElementById('score-display').innerText = score;
                
                // √Çm thanh ƒë√∫ng (n·∫øu c√≥ th·ªÉ th√™m)
                
                setTimeout(() => {
                    nextQuestion();
                }, 1000);
            } else {
                // SAI
                feedback.innerText = "SAI R·ªíI! ƒêang ƒë·ªïi c√¢u h·ªèi kh√°c...";
                feedback.classList.add("wrong");
                
                // Tr·ª´ th·ªùi gian ph·∫°t (tu·ª≥ ch·ªçn)
                timeLeft -= 10; 
                
                setTimeout(() => {
                    replaceQuestion();
                }, 1500);
            }
        }

        function replaceQuestion() {
            // Logic: L·∫•y 1 c√¢u kh√°c c√πng lo·∫°i t·ª´ ng√¢n h√†ng c√¢u h·ªèi thay th·∫ø v√†o v·ªã tr√≠ hi·ªán t·∫°i
            const currentType = currentQuestions[currentQuestionIndex].type;
            const pool = questionBank.filter(q => q.type === currentType);
            
            // Ch·ªçn ng·∫´u nhi√™n 1 c√¢u kh√°c c√¢u hi·ªán t·∫°i
            let newQ;
            let attempts = 0;
            do {
                newQ = pool[Math.floor(Math.random() * pool.length)];
                attempts++;
            } while (newQ === currentQuestions[currentQuestionIndex] && attempts < 10);

            currentQuestions[currentQuestionIndex] = newQ;
            loadQuestion();
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= currentQuestions.length) {
                levelComplete();
            } else {
                loadQuestion();
            }
        }

        function levelComplete() {
            clearInterval(timerInterval);
            switchScreen('result-screen');
            document.getElementById('final-score').innerText = score;
            
            // Ph·∫ßn th∆∞·ªüng
            let earnedGems = Math.floor(score / 5);
            gems += earnedGems;
            document.getElementById('final-gems').innerText = earnedGems;
            document.getElementById('gem-display').innerText = gems;

            let msg = document.getElementById('reward-msg');
            if (score >= 200) {
                msg.innerText = "Xu·∫•t s·∫Øc! B·∫°n nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu 'Cyber Master'!";
            } else {
                msg.innerText = "L√†m t·ªët l·∫Øm! C·ªë g·∫Øng h∆°n ·ªü m√†n sau.";
            }
            
            saveScore();
        }

        function nextLevel() {
            currentLevel++;
            startLevel();
        }

        function resetGame() {
            switchScreen('login-screen');
        }

    </script>
</body>
</html>
